!function(y){"use strict";y(document).ready(function(){var t=0,n=null;y.ajaxPrefilter(function(e,a,t){if(a.hasOwnProperty("data")&&a.data.hasOwnProperty("action")){var i=a.data.action;if("new_activity_comment"==i)0!=(n=y("#ac-form-"+a.data.form_id).find('input[name="attachments_files[]"]').map(function(e,a){return y(a).val()}).get()).length&&(e.data+="&attachments_files="+n,""==a.data.content&&(e.data+="&content={{{youzify_comment_attachment}}}"));else if("messages_send_reply"==i){var n;0!=(n=y("#send-reply").find('input[name="attachments_files[]"]').map(function(e,a){return y(a).val()}).get()).length&&(e.data+="&attachments_files="+n,""==a.data.content&&(e.data+="&content={{{youzify_message_attachment}}}"))}}}),y(document).ajaxSuccess(function(e,a,t){if("[object String]"==Object.prototype.toString.call(t.data)){var i=a.responseText;if(i[0]+i[1]!="-1"){var n=y.youzify_getUrlParameter(t.data,"action");"new_activity_comment"==n?(y("#ac-form-"+y.youzify_getUrlParameter(t.data,"form_id")).find(".youzify-delete-attachment").trigger("click"),y("#ac-form-"+y.youzify_getUrlParameter(t.data,"form_id")).find(".youzify-wall-upload-btn").fadeIn()):"messages_send_reply"==n&&(y("#send-reply").find(".youzify-delete-attachment").trigger("click"),y("#send-reply").find(".youzify-upload-btn").fadeIn())}}}),y(document).on("change",".youzify-upload-attachments",function(e){e.preventDefault();var a=y(this).closest("form");if(a.hasClass("ac-form")&&(a.find(".youzify-wall-upload-btn").fadeOut(),a.find(".youzify-attachment-item")[0]))return!1;var t=y(this).closest(".youzify-attachments"),i=t.find(".youzify-wall-item-upload");if(i[0]&&(i.fadeOut(1),t.find(".youzify-attachment-item")[0]))return!1;n=y(this).get(0),y.youzify_UploadFiles(a,t,{attachments:n})}),y.youzify_UploadFiles=function(e,a,t){for(var i=y.extend({},t).attachments.files,n=0;n<i.length;n++){var o=i[n];if(e.hasClass("youzify-wall-form")){if(!y.youzify_CheckFilesNumber(e))return!1}else if(e.find(".youzify-attachment-item")[0])return!1;var f=y.youzifyAttachmentItem({file:o,input_name:a.attr("data-name")?a.attr("data-name"):"attachments_files[]",file_name:o.name});e.hasClass("ac-form")?e.find(".youzify-wall-upload-btn").fadeOut(1):"send-reply"!=e.attr("id")&&"send_message_form"!=e.attr("id")||e.find(".youzify-upload-btn").fadeOut(1),a.find(".youzify-form-attachments").append(f),0==n&&y.youzify_UploadFile(e,a,o)}},y.youzifyAttachmentItem=function(e){var a,t,i=y.extend({},e);return a='<div class="youzify-attachment-item youzify-file-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i><span class="youzify-file-name">'+y.youzify_GetNameExcerpt(i.file_name)+'</span></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',t='<div class="youzify-attachment-item youzify-image-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',y.youzify_CheckIsFileImage(i.file)?t:a},y.youzify_UploadFile=function(n,o,f){var s=o.find(".youzify-file-progress:first").parent(".youzify-attachment-item"),e=new FormData;e.append("file",f),n.hasClass("youzify-wall-form")?(e.append("target","activity"),e.append("post_type",n.find('input:radio[name="post_type"]:checked').val())):n.hasClass("ac-form")?e.append("target","comment"):"send-reply"!=n.closest("form").attr("id")&&"send_message_form"!=n.closest("form").attr("id")||e.append("target","message"),e.append("attachments_number",n.find(".youzify-attachment-item").length),e.append("action","youzify_upload_wall_attachments"),e.append("security",Youzify.security_nonce),y.ajax({type:"POST",url:Youzify.ajax_url,data:e,cache:!1,contentType:!1,processData:!1,xhr:function(){var e=y.ajaxSettings.xhr();return e.upload&&(n.find(".youzify-wall-post,.youzify-update-post").attr("disabled",!0),e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=e.total,t=100*e.loaded/a,i=s.find(".youzify-file-upload");s.find(".youzify-file-icon").attr("class","fas fa-spinner fa-spin youzify-file-icon"),i.css("width",t+"%"),100<=t&&i.addClass("youzify-file-uploaded")}})),e},success:function(e){if(0==e.success)return y.youzify_DialogMsg("error",e.data.error),n.hasClass("ac-form")?n.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=n.attr("id")&&"send_message_form"!=n.attr("id")||n.find(".youzify-upload-btn").fadeIn(),o.hasClass("youzify-cf-attachment")&&o.find(".youzify-wall-item-upload").fadeIn(),s.remove(),y.youzify_CheckUploadProgress(n),!1;var a=e.data.base_url;s.find(".youzify-file-progress").fadeOut(400,function(){y(this).remove(),y.youzify_upload_next_file(n,o),y.youzify_CheckUploadProgress(n)}),y.youzify_CheckIsFileImage(f)&&s.find(".youzify-file-icon").remove(),s.find(".youzify-file-icon").attr("class","fas fa-paperclip youzify-file-icon"),s.find(".youzify-attachment-details").append('<i class="fas fa-trash-alt youzify-delete-attachment"></i>'),delete e.data.base_url,s.find(".youzify-attachment-data").val(JSON.stringify(e.data));var i=new FileReader;f.type.match("video.*")&&(i.onload=function(){var e=new Blob([i.result],{type:f.type}),n=URL.createObjectURL(e),o=document.createElement("video"),a=function(){t()&&(o.removeEventListener("timeupdate",a),o.pause())};o.addEventListener("loadeddata",function(){t()&&o.removeEventListener("timeupdate",a)});var t=function(){var e=document.createElement("canvas");e.width=o.videoWidth,e.height=o.videoHeight,e.getContext("2d").drawImage(o,0,0,e.width,e.height);var a=e.toDataURL("image/jpeg"),t=1e5<a.length;if(t){var i=JSON.parse(s.find(".youzify-attachment-data").val());i.video_thumbnail=a,s.find(".youzify-attachment-data").val(JSON.stringify(i)),URL.revokeObjectURL(n)}return t};o.addEventListener("timeupdate",a),o.preload="metadata",o.src=n,o.muted=!0,o.playsInline=!0,o.play()},i.readAsArrayBuffer(f)),s.css("background-image","url("+a+"temp/"+e.data.original+")")},error:function(e,a,t){s.remove(),y.youzify_DialogMsg("error",a),y.youzify_CheckUploadProgress(n),y.youzify_upload_next_file(n,o)}})},y.youzify_upload_next_file=function(e,a){t++,null!==n&&void 0!==n.files[t]&&y.youzify_UploadFile(e,a,n.files[t])},y(document).on("click",".youzify-delete-attachment",function(e){var a=y(this).closest("form");a.hasClass("ac-form")?a.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=a.attr("id")&&"send_message_form"!=a.attr("id")||a.find(".youzify-upload-btn").fadeIn(),y(this).closest(".youzify-attachments").find(".youzify-wall-item-upload").fadeIn();var t=y(this).closest(".youzify-attachment-item");if(t.find(".youzify-attachment-data").get(0)){var i=y.parseJSON(t.find(".youzify-attachment-data").val());y.youzify_DeleteAttachment(i.original)}t.remove()}),y.youzify_DeleteAttachment=function(e){var a=new FormData;a.append("attachment",e),a.append("security",Youzify.security_nonce),a.append("action","youzify_delete_wall_attachment"),y.ajax({type:"POST",data:a,url:ajaxurl,contentType:!1,processData:!1})},y.youzify_GetNameExcerpt=function(e){if(e.length<=25)return e;var a=25-"...".length,t=Math.ceil(a/2),i=Math.floor(a/2);return e.substr(0,t)+"..."+e.substr(e.length-i)},y.youzify_CheckIsFileImage=function(e){var a=e.type;return!(y.inArray(a,["image/gif","image/jpeg","image/png"])<0)},y.youzify_CheckUploadProgress=function(e){e.find(".youzify-file-progress")[0]||(e.find(".youzify-upload-attachments").val(""),e.find('.youzify-wall-actions button[type="submit"]').attr("disabled",!1),t=0,n=null)},y.youzify_CheckFilesNumber=function(e){var a=e.find('input:radio[name="post_type"]:checked').val();return"activity_photo"==a||"activity_poll"==a||"activity_slideshow"==a||!e.find(".youzify-attachment-item")[0]||(n=null,y.youzify_DialogMsg("error",Youzify_Wall.max_one_file),!1)},y.youzify_getUrlParameter=function(e,a){var t,i,n=e.split("&");for(i=0;i<n.length;i++)if((t=n[i].split("="))[0]===a)return void 0===t[1]||decodeURIComponent(t[1])}})}(jQuery);